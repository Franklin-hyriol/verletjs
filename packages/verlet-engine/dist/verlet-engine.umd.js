(function(l,o){typeof exports=="object"&&typeof module<"u"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(l=typeof globalThis<"u"?globalThis:l||self,o(l["verlet-engine"]={}))})(this,(function(l){"use strict";class o{x;y;constructor(t,s){this.x=t||0,this.y=s||0}add(t){return new o(this.x+t.x,this.y+t.y)}sub(t){return new o(this.x-t.x,this.y-t.y)}mul(t){return new o(this.x*t.x,this.y*t.y)}div(t){return new o(this.x/t.x,this.y/t.y)}scale(t){return new o(this.x*t,this.y*t)}mutableSet(t){return this.x=t.x,this.y=t.y,this}mutableAdd(t){return this.x+=t.x,this.y+=t.y,this}mutableSub(t){return this.x-=t.x,this.y-=t.y,this}mutableMul(t){return this.x*=t.x,this.y*=t.y,this}mutableDiv(t){return this.x/=t.x,this.y/=t.y,this}mutableScale(t){return this.x*=t,this.y*=t,this}equals(t){return this.x===t.x&&this.y===t.y}epsilonEquals(t,s){return Math.abs(this.x-t.x)<=s&&Math.abs(this.y-t.y)<=s}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}length2(){return this.x*this.x+this.y*this.y}dist(t){return Math.sqrt(this.dist2(t))}dist2(t){const s=t.x-this.x,i=t.y-this.y;return s*s+i*i}normal(){const t=Math.sqrt(this.x*this.x+this.y*this.y);return new o(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}angle(t){return Math.atan2(this.x*t.y-this.y*t.x,this.x*t.x+this.y*t.y)}angle2(t,s){return t.sub(this).angle(s.sub(this))}rotate(t,s){const i=this.x-t.x,e=this.y-t.y;return new o(i*Math.cos(s)-e*Math.sin(s)+t.x,i*Math.sin(s)+e*Math.cos(s)+t.y)}toString(){return`(${this.x}, ${this.y})`}}class u{a;b;distance;stiffness;constructor(t,s,i,e){this.a=t,this.b=s,this.distance=typeof e<"u"?e:t.pos.sub(s.pos).length(),this.stiffness=i}relax(t){const s=this.a.pos.sub(this.b.pos),i=s.length2();s.mutableScale((this.distance*this.distance-i)/i*this.stiffness*t),this.a.pos.mutableAdd(s),this.b.pos.mutableSub(s)}draw(t){t.beginPath(),t.moveTo(this.a.pos.x,this.a.pos.y),t.lineTo(this.b.pos.x,this.b.pos.y),t.strokeStyle="#d8dde2",t.stroke()}}class w{a;pos;constructor(t,s){this.a=t,this.pos=new o().mutableSet(s)}relax(t){this.a.pos.mutableSet(this.pos)}draw(t){t.beginPath(),t.arc(this.pos.x,this.pos.y,6,0,2*Math.PI),t.fillStyle="rgba(0,153,255,0.1)",t.fill()}}class b{a;b;c;angle;stiffness;constructor(t,s,i,e){this.a=t,this.b=s,this.c=i,this.angle=this.b.pos.angle2(this.a.pos,this.c.pos),this.stiffness=e}relax(t){let i=this.b.pos.angle2(this.a.pos,this.c.pos)-this.angle;i<=-Math.PI?i+=2*Math.PI:i>=Math.PI&&(i-=2*Math.PI),i*=t*this.stiffness,this.a.pos=this.a.pos.rotate(this.b.pos,i),this.c.pos=this.c.pos.rotate(this.b.pos,-i),this.b.pos=this.b.pos.rotate(this.a.pos,i),this.b.pos=this.b.pos.rotate(this.c.pos,-i)}draw(t){t.beginPath(),t.moveTo(this.a.pos.x,this.a.pos.y),t.lineTo(this.b.pos.x,this.b.pos.y),t.lineTo(this.c.pos.x,this.c.pos.y);const s=t.lineWidth;t.lineWidth=5,t.strokeStyle="rgba(255,255,0,0.2)",t.stroke(),t.lineWidth=s}}typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=function(h){return window.setTimeout(()=>h(performance.now()),1e3/60)});class f{pos;lastPos;constructor(t){this.pos=new o().mutableSet(t),this.lastPos=new o().mutableSet(t)}draw(t){t.beginPath(),t.arc(this.pos.x,this.pos.y,2,0,2*Math.PI),t.fillStyle="#2dad8f",t.fill()}}class y{particles=[];constraints=[];drawParticles;drawConstraints;pin(t,s){s=s||this.particles[t].pos;const i=new w(this.particles[t],s);return this.constraints.push(i),i}}class d{width;height;canvas;ctx;mouse=new o(0,0);mouseDown=!1;draggedEntity=null;selectionRadius=20;highlightColor="#4f545c";gravity=new o(0,.2);friction=.99;groundFriction=.8;composites=[];constructor(t,s,i){this.width=t,this.height=s,i&&(this.canvas=i,this.ctx=i.getContext("2d"),this.initDraggable())}bounds=t=>{t.pos.y>this.height-1&&(t.pos.y=this.height-1),t.pos.x<0&&(t.pos.x=0),t.pos.x>this.width-1&&(t.pos.x=this.width-1)};initDraggable(){this.canvas&&(this.canvas.oncontextmenu=t=>{t.preventDefault()},this.canvas.onmousedown=t=>{this.mouseDown=!0;const s=this.nearestEntity();s&&(this.draggedEntity=s)},this.canvas.onmouseup=t=>{this.mouseDown=!1,this.draggedEntity=null},this.canvas.onmousemove=t=>{if(!this.canvas)return;const s=this.canvas.getBoundingClientRect();this.mouse.x=t.clientX-s.left,this.mouse.y=t.clientY-s.top})}frame(t){for(const i of this.composites)for(const e of i.particles){const a=e.pos.sub(e.lastPos).scale(this.friction);if(e.pos.y>=this.height-1&&a.length2()>1e-6){const n=a.length();a.x/=n,a.y/=n,a.mutableScale(n*this.groundFriction)}e.lastPos.mutableSet(e.pos),e.pos.mutableAdd(this.gravity),e.pos.mutableAdd(a)}this.draggedEntity&&this.draggedEntity.pos.mutableSet(this.mouse);const s=1/t;for(const i of this.composites)for(let e=0;e<t;++e)for(const a of i.constraints)a.relax(s);for(const i of this.composites)for(const e of i.particles)this.bounds(e)}draw(){if(!this.ctx||!this.canvas)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const s of this.composites){if(s.drawConstraints)s.drawConstraints(this.ctx,s);else for(const i of s.constraints)i.draw(this.ctx);if(s.drawParticles)s.drawParticles(this.ctx,s);else for(const i of s.particles)i.draw(this.ctx)}const t=this.draggedEntity||this.nearestEntity();t&&(this.ctx.beginPath(),this.ctx.arc(t.pos.x,t.pos.y,8,0,2*Math.PI),this.ctx.strokeStyle=this.highlightColor,this.ctx.stroke())}nearestEntity(){let t=0,s=null,i=null;for(const e of this.composites)for(const a of e.particles){const n=a.pos.dist2(this.mouse);n<=this.selectionRadius*this.selectionRadius&&(s==null||n<t)&&(s=a,i=e.constraints,t=n)}if(i){for(const e of i)if(e instanceof w&&e.a===s)return e}return s}}d.prototype.point=function(h){const t=new y;return t.particles.push(new f(h)),this.composites.push(t),t},d.prototype.lineSegments=function(h,t){const s=new y;for(let i=0;i<h.length;i++)s.particles.push(new f(h[i])),i>0&&s.constraints.push(new u(s.particles[i],s.particles[i-1],t));return this.composites.push(s),s},d.prototype.cloth=function(h,t,s,i,e,a){const n=new y,x=t/i,c=s/i;for(let r=0;r<i;++r)for(let p=0;p<i;++p){const m=h.x+p*x-t/2+x/2,g=h.y+r*c-s/2+c/2;n.particles.push(new f(new o(m,g))),p>0&&n.constraints.push(new u(n.particles[r*i+p],n.particles[r*i+p-1],a)),r>0&&n.constraints.push(new u(n.particles[r*i+p],n.particles[(r-1)*i+p],a))}for(let r=0;r<i;++r)r%e===0&&n.pin(r);return this.composites.push(n),n},d.prototype.tire=function(h,t,s,i,e){const a=2*Math.PI/s,n=new y;for(let c=0;c<s;++c){const r=c*a;n.particles.push(new f(new o(h.x+Math.cos(r)*t,h.y+Math.sin(r)*t)))}const x=new f(h);n.particles.push(x);for(let c=0;c<s;++c)n.constraints.push(new u(n.particles[c],n.particles[(c+1)%s],e)),n.constraints.push(new u(n.particles[c],x,i)),n.constraints.push(new u(n.particles[c],n.particles[(c+5)%s],e));return this.composites.push(n),n},l.AngleConstraint=b,l.Composite=y,l.DistanceConstraint=u,l.Particle=f,l.PinConstraint=w,l.Vec2=o,l.VerletJS=d,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})}));
